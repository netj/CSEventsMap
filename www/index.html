<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>Computer Science Academic Events Map</title>
    <script type="text/javascript" src="d3/d3.js"></script>
    <script type="text/javascript" src="d3/d3.geo.js"></script>
    <script type="text/javascript" src="d3/lib/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="d3/lib/jquery-ui/jquery-ui.min.js"></script>
    <style type="text/css">
        @import url("d3/lib/jquery-ui/jquery-ui.css");

        /* XXX debug */ .frame { border: 1px solid #f00; } svg { border: 1px solid red; }

        body, .ui-widget {
            font: 14px 'Helvetica Neue';
        }

        body {
          font-size: 12px;
          color: #999;
          background-color: #000;
          margin: 0px; padding: 0px;
        }
        a {
          color: #c93;
          text-decoration: none;
        }
        a:hover {
          color: #f88;
        }

        h1, h2 { margin: 0; }
        h1 { font-size: 13px; }
        h2 { font-size: 12px; }

        .frame { position: absolute; }
        #title {
          left: 7px;
          bottom: 7px;
        }
        #caption {
          right: 5px;
          bottom: 5px;
        }

        #yearly {
          height: 120px;
          bottom: 30px;
          left: 0px;
          right: 260px;
          padding: 10px;
        }
        #year-range-slider {
          height: 5px;
          margin: 5px 10px;
          background: #222;
          border-color: #444;
        }
        #year-range-slider .ui-slider-range {
          background: #a81;
          cursor: pointer;
        }
        #year-range-slider .ui-slider-handle {
          height: 10px;
          background: #666;
          border-color: #999;
          cursor: pointer;
        }
        #yearly .subtitle input {
          background-color: inherit;
          color: inherit;
          border: 1px solid #999;
          text-align: center;
        }
        #yearly svg {
          height: 80px;
          bottom: 0px;
        }
        #yearly-stats rect {
          fill: #a81;
        }

        #details {
          top: 5px;
          right: 10px;
          width: 230px;
          bottom: 35px;
          padding: 10px;
          overflow: auto;
          background-color: #222;
          border: 1px solid #444;
          border-radius: 10px;
          box-shadow: 0px 2px 15px #444;
        }
        #details ul {
          padding: 0px 10px 0px 20px;
          margin: 5px 0px;
        }

        #map {
          z-index: -1;
          display: block;
          top: 0px;
          left: 0px;
          right: 260px;
          bottom: 170px;
          background-color: #000;
        }
        #map .subtitle {
          position: absolute;
          top: 10px;
          left: 10px;
        }

        #map svg {
          width: 100%;
          height: 100%;
          cursor: url(http://www.worldtimzone.com/mozilla/testcase/css3cursors_files/grab.gif);
        }
        #map svg.dragging {
          cursor: url(http://www.worldtimzone.com/mozilla/testcase/css3cursors_files/grabbing.gif);
        }

        #countries path {
            fill: #222;
            stroke: #444;
        }

        #eventsMap .event {
            fill: rgba(255,192,32, 0.3);
            cursor: pointer;
        }
        #eventsMap .event:hover, #eventsMap .event:active {
            stroke: #f44;
        }
    </style>
  </head>

  <body>

<h1 id="title" class="frame" style="display: inline;">Computer Science Academic Events Map</h1>
<div id="caption" class="frame">
Created by <a href="http://github.com/netj">Jaeho Shin</a>.

Source:
<a href="http://www.informatik.uni-trier.de/~ley/db/">DBLP XML</a>,
<a href="http://www.st.ewi.tudelft.nl/~mathijs/conf/">Confy RSS</a>.
</div>

<div id="map" class="frame">
  <h2 class="subtitle">Geographical View</h2>
</div>
    
<div id="yearly" class="frame">
  <h2 class="subtitle">Yearly Stats <input type="text" size="4" id="yearL"> ~ <input type="text" size="4" id="yearU"></h2>
  <div id="yearly-stats"></div>
  <div id="year-range-slider"></div>
</div>

<div id="details" class="frame">
  <h2 class="subtitle">Events Detail</h2>
  <ul id="list"></ul>
</div>

<script type="text/javascript">
// Code derived from d3's Mercator Projection example

// Our projection.
var xy = d3.geo.mercator(),
    path = d3.geo.path().projection(xy);

var map = d3.select("#map")
  .append("svg:svg")
    .attr("id", "map-canvas");
var countries = map
  .append("svg:g")
    .attr("id", "countries");
var eventsMap = map.append("svg:g")
    .attr("id", "eventsMap");
var yearlyStats = d3.select("#yearly-stats")
  .append("svg:svg")
    .attr("id", "yearly-stats-canvas");

d3.json("d3/examples/data/world-countries.json", function(collection) {
  countries
    .selectAll("path")
      .data(collection.features)
    .enter().append("svg:path")
      .attr("d", path)
    .append("svg:title")
      .text(function(d) { return d.properties.name; });
});

d3.id = function(d) { return d; };
d3.proj = function(name) { return function(d) { return d[name]; }; }

function indexBy(records, keyfn) {
    var index = {};
    for (var i in records) {
        var r = records[i];
        var k = keyfn(r);
        if (index[k] == null)
            index[k] = [];
        index[k].push(r);
    }
    return index;
}

var useFirstInGroup = function(use) { return function(d) { return use(d[0]); }; };
var useLength  = function(d) { return d.length; };
var useYear = function(d) { return parseInt(d.begins.replace(/-.*$/, "")); };
var useTitle = function(d) { return d.title; }

var allEvents;

function showYearly() {
  var canvas = $("#yearly-stats svg")[0];
  var width = canvas.offsetWidth;
  var height = canvas.offsetHeight;

  var eventGroupsByYear = indexBy(allEvents, useYear);
  var yearGroups = d3.values(eventGroupsByYear);
  var minYear = d3.min(yearGroups, useFirstInGroup(useYear));
  var maxYear = d3.max(yearGroups, useFirstInGroup(useYear));
  var x = d3.scale.linear()
      .domain([minYear, maxYear])
      .range([0, width])
      ;
  var maxCount = d3.max(yearGroups, useLength);
  var y = d3.scale.linear()
      .domain([0, maxCount])
      .range([0, height])
      ;

  var barWidthToSpacing = 0.8;
  var barWidth = (width / (maxYear - minYear + 1)) * barWidthToSpacing;

  yearlyStats
    .selectAll("rect")
      .data(yearGroups, function(d) { return useYear(d[0]); })
    .enter().append("svg:rect")
      .attr("x", function(d) { return x(useYear(d[0])); })
      .attr("y", function(d) { return height - y(d.length); })
      .attr("height", function(d) { return y(d.length); })
      .attr("width", barWidth)
      ;
}


function showDetails(groups) {
  // TODO sorting?
  var eventsInInterest = groups.reduce(function(a,b){ return a.concat(b); })
  d3.select("#list")
    .selectAll("li")
      .data(eventsInInterest, useTitle)
    .enter().append("li")
    .append("a")
      .attr("href", generateURL)
      .text(useTitle)
      ;
  d3.select("#list")
    .selectAll("li")
      .data(eventsInInterest, useTitle)
    .exit().remove()
    ;
}
function generateURL(conf) {
  return conf.url;
}


function refresh() {
  countries
    .selectAll("path")
      .attr("d", path);
}


// load events data
d3.json("data/conferences.json", function(data) {
  allEvents = data;
  var allEventsByLocation = indexBy(allEvents,
      function(d) { return d.latitude+","+d.longitude; });

  var events = d3.values(allEventsByLocation);
  var maxCount = d3.max(events, function(d) { return d.length; });
  var bubbleScale = d3.scale.linear()
      .domain([1, maxCount])
      .range([1, 10])

  eventsMap
    .selectAll(".event")
      .data(events)
    .enter().append("svg:circle")
      .attr("class", "event")
      .attr("cx", function(d) { return xy([d[0].longitude, d[0].latitude])[0]; })
      .attr("cy", function(d) { return xy([d[0].longitude, d[0].latitude])[1]; })
      .attr("r", function(d) { return bubbleScale(d.length); })
      .on("click", function(d) { showDetails([d]); })
    .append("svg:title")
      .text(function(d) { return d.length; })
      ;

  var minYear = d3.min(allEvents, useYear);
  var maxYear = d3.max(allEvents, useYear);

  // prepare the year range scale
  var yearSlider = $("#year-range-slider").slider({
    range: true,
    min: minYear,
    max: maxYear,
    step: 1,
    values: [minYear, maxYear],
    slide: function(event, ui) {
      $("#yearL").val(ui.values[0]);
      $("#yearU").val(ui.values[1]);
      refresh();
    }
  });
  // validate entered values
  var validateYearInput = function(i) {
    var y = parseInt(i.value);
    if (y > maxYear)
      y = maxYear;
    else if (y < minYear)
      y = minYear;
    i.value = y;
    return y;
  };
  $("#yearL").val(minYear).change(function() { yearSlider.slider("values", [validateYearInput(this), $("#yearU")[0].value]); });
  $("#yearU").val(maxYear).change(function() { yearSlider.slider("values", [$("#yearL")[0].value, validateYearInput(this)]); });;

  showYearly();

});

    </script>
  </body>
</html>
