<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>Computer Science Academic Events Map</title>
    <script type="text/javascript" src="d3/d3.js"></script>
    <script type="text/javascript" src="d3/d3.geo.js"></script>
    <script type="text/javascript" src="d3/lib/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="d3/lib/jquery-ui/jquery-ui.min.js"></script>
    <style type="text/css">

@import url("d3/lib/jquery-ui/jquery-ui.css");

body, .ui-widget {
  font: 14px Helvetica Neue;
}

svg {
  width: 800px;
  height: 600px;
  background-color: #111;
}

#countries path {
  fill: #333;
  stroke: #eee;
}

#eventsMap .event {
    fill: rgba(255,192,32, 0.3);
}

#eventsMap .event:hover, #eventsMap .event:active {
    stroke: #f00;
}

    </style>
  </head>
  <body>
    <h3>Computer Science Academic Events Map</h3>
    <script type="text/javascript">
// Code derived from d3's Mercator Projection example

// Our projection.
var xy = d3.geo.mercator(),
    path = d3.geo.path().projection(xy);

var map = d3.select("body")
  .append("svg:svg")
    .attr("id", "map");
var countries = map
  .append("svg:g")
    .attr("id", "countries");

d3.json("d3/examples/data/world-countries.json", function(collection) {
  countries
    .selectAll("path")
      .data(collection.features)
    .enter().append("svg:path")
      .attr("d", path)
    .append("svg:title")
      .text(function(d) { return d.properties.name; });
});

function refresh() {
  countries
    .selectAll("path")
      .attr("d", path);
}

function indexBy(records, keyfn) {
    var index = {};
    for (var i in records) {
        var r = records[i];
        var k = keyfn(r);
        if (index[k] == null)
            index[k] = [];
        index[k].push(r);
    }
    return index;
}

var eventsMap = map.append("svg:g")
    .attr("id", "eventsMap");

var ID = function(d) { return d; };
var proj = function(name) { return function(d) { return d[name]; }; }
d3.map = function(arr, fn) {
    var mapped = [];
    for (var i=0; arr.length>i; i++)
        mapped.push(fn(arr[i]));
    return mapped;
};

var longitude = function(d) { return d[0].longitude; };
var latitude = function(d) { return d[0].latitude; };

// load events data
var allEvents;
var allEventsByLocation;
d3.json("data/conferences.json", function(data) {
        allEvents = data;
        allEventsByLocation = indexBy(allEvents,
            function(d) { return d.latitude+","+d.longitude; });

        var events = d3.values(allEventsByLocation);
        var maxCount = d3.max(events, function(d) { return d.length; });
        var bubbleScale = d3.scale.linear()
            .domain([1, maxCount])
            .range([1, 10])

        eventsMap
          .selectAll(".event")
            .data(events)
          .enter().append("svg:circle")
            .attr("class", "event")
            .attr("cx", function(d) { return xy([d[0].longitude, d[0].latitude])[0]; })
            .attr("cy", function(d) { return xy([d[0].longitude, d[0].latitude])[1]; })
            .attr("r", function(d) { return bubbleScale(d.length); })
            .on("click", function(d) { console.log(d3.map(d, proj("title"))); })
          .append("svg:title")
            .text(function(d) { return d.length; })
            ;
});

    </script>
    
    <!--
    <p>
    <div id="scale">scale: <span>500</span></div><p>
    <div id="translate-x">translate.x: <span>480</span></div>
    <div id="translate-y">translate.y: <span>250</span></div>
    <script type="text/javascript">

$("#scale").slider({
  min: 0,
  max: 3000,
  value: 500,
  slide: function(event, ui) {
    xy.scale(ui.value);
    refresh();
  }
});

$("#translate-x").slider({
  min: -2000,
  max: 2000,
  value: 480,
  slide: function(event, ui) {
    var translate = xy.translate();
    translate[0] = ui.value;
    xy.translate(translate);
    refresh();
  }
});

$("#translate-y").slider({
  min: -2000,
  max: 2000,
  value: 250,
  slide: function(event, ui) {
    var translate = xy.translate();
    translate[1] = ui.value;
    xy.translate(translate);
    refresh();
  }
});

    </script>
    -->
  </body>
</html>
